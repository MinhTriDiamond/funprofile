

## ğŸŒŸ Káº¿ Hoáº¡ch TÃ­ch Há»£p ANGEL AI vÃ o FUN Profile

BÃ© TrÃ­ Æ¡i, Angel Ä‘Ã£ phÃ¢n tÃ­ch xong há»‡ thá»‘ng! DÆ°á»›i Ä‘Ã¢y lÃ  káº¿ hoáº¡ch triá»ƒn khai Ä‘áº§y Ä‘á»§ Ä‘á»ƒ tÃ­ch há»£p **ANGEL AI** (REST API + Streaming) vÃ o FUN Profile.

---

### ğŸ“‹ Tá»•ng Quan

| ThÃ nh pháº§n | MÃ´ táº£ |
|------------|-------|
| **Kiá»ƒu 1** | Floating Bubble + Navbar Button â†’ Má»Ÿ trang `angel.fun.rich` |
| **Kiá»ƒu 2** | Embedded Chat Widget â†’ NhÃºng streaming chat ngay trong FUN Profile |
| **API** | REST API vá»›i Server-Sent Events (SSE) Streaming |
| **Báº£o máº­t** | API KEY lÆ°u trong Supabase Secrets |

---

### ğŸ—ï¸ Kiáº¿n TrÃºc Há»‡ Thá»‘ng

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ANGEL AI INTEGRATION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  FUN Profile UI  â”‚     â”‚   AngelWidget     â”‚                     â”‚
â”‚  â”‚                  â”‚     â”‚   (Embedded Chat) â”‚                     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚                   â”‚                     â”‚
â”‚  â”‚  â”‚  Floating  â”‚  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     â”‚
â”‚  â”‚  â”‚  Bubble    â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚ angel.fun.  â”‚  â”‚                     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â”‚   rich      â”‚  â”‚                     â”‚
â”‚  â”‚                  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚        OR         â”‚                     â”‚
â”‚  â”‚  â”‚  Navbar    â”‚  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     â”‚
â”‚  â”‚  â”‚  Button    â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚ Embedded    â”‚  â”‚                     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â”‚ Chat (SSE)  â”‚â—€â”€â”¼â”€â”€â”€â”                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚                 â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                 â”‚
â”‚                                                    â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 EDGE FUNCTION                   â”‚               â”‚â”‚
â”‚  â”‚   supabase/functions/angel-chat/index.ts        â”‚               â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚   â”‚  1. Nháº­n messages tá»« client                               â”‚ â”‚â”‚
â”‚  â”‚   â”‚  2. Gá»i ANGEL AI API (angel.fun.rich)                     â”‚ â”‚â”‚
â”‚  â”‚   â”‚  3. Stream response vá» client (SSE)                       â”‚ â”‚â”‚
â”‚  â”‚   â”‚  4. Xá»­ lÃ½ errors (429, 402, 500)                          â”‚ â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                              â”‚                                  â”‚â”‚
â”‚  â”‚                              â–¼                                  â”‚â”‚
â”‚  â”‚                    ANGEL_AI_API_KEY                             â”‚â”‚
â”‚  â”‚                    (Supabase Secrets)                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ“ CÃ¡c File Cáº§n Táº¡o/Sá»­a

| File | HÃ nh Ä‘á»™ng | MÃ´ táº£ |
|------|-----------|-------|
| `src/components/angel-ai/AngelFloatingButton.tsx` | **Táº¡o má»›i** | Floating bubble vá»›i avatar thiÃªn tháº§n (má»Ÿ `angel.fun.rich`) |
| `src/components/angel-ai/AngelChatWidget.tsx` | **Táº¡o má»›i** | Embedded chat widget vá»›i streaming SSE |
| `src/components/angel-ai/AngelMessage.tsx` | **Táº¡o má»›i** | Component hiá»ƒn thá»‹ tin nháº¯n (há»— trá»£ Markdown) |
| `src/hooks/useAngelChat.ts` | **Táº¡o má»›i** | Hook xá»­ lÃ½ streaming chat vá»›i ANGEL AI |
| `supabase/functions/angel-chat/index.ts` | **Táº¡o má»›i** | Edge function proxy gá»i ANGEL AI API |
| `src/components/layout/FacebookNavbar.tsx` | **Sá»­a** | ThÃªm ANGEL AI icon vÃ o center nav |
| `src/components/layout/MobileBottomNav.tsx` | **Sá»­a** | ThÃªm AngelFloatingButton |
| `supabase/config.toml` | **Sá»­a** | ThÃªm config cho angel-chat function |

---

### ğŸ” BÆ°á»›c 0: ThÃªm API KEY vÃ o Secrets

TrÆ°á»›c khi báº¯t Ä‘áº§u code, bÃ© TrÃ­ cáº§n thÃªm **ANGEL_AI_API_KEY** vÃ o Supabase Secrets. Angel sáº½ yÃªu cáº§u bÃ© nháº­p key khi báº¯t Ä‘áº§u triá»ƒn khai.

---

### ğŸ¨ BÆ°á»›c 1: AngelFloatingButton (Truy cáº­p trá»±c tiáº¿p)

**Vá»‹ trÃ­:** GÃ³c pháº£i mÃ n hÃ¬nh, phÃ­a trÃªn Bottom Nav (mobile only)

**TÃ­nh nÄƒng:**
- Avatar thiÃªn tháº§n tá»« `src/assets/angel-avatar.jpg`
- Glow ring effect vá»›i gradient gold
- Pulse animation thu hÃºt sá»± chÃº Ã½
- Click â†’ Má»Ÿ `angel.fun.rich` trong tab má»›i

**Code máº«u:**
```typescript
// AngelFloatingButton.tsx
import angelAvatar from '@/assets/angel-avatar.jpg';
import { Sparkles } from 'lucide-react';

export const AngelFloatingButton = () => {
  return (
    <button 
      onClick={() => window.open('https://angel.fun.rich', '_blank')}
      className="fixed bottom-24 right-4 z-50 lg:hidden"
    >
      {/* Glow ring */}
      <div className="absolute inset-0 w-14 h-14 rounded-full 
        bg-gradient-to-br from-amber-400/50 to-yellow-500/50 
        blur-md animate-pulse" />
      {/* Avatar */}
      <div className="relative w-14 h-14 rounded-full overflow-hidden 
        border-2 border-amber-400 shadow-lg shadow-amber-500/50">
        <img src={angelAvatar} alt="ANGEL AI" className="w-full h-full object-cover" />
      </div>
      {/* Sparkle */}
      <Sparkles className="absolute -top-1 -right-1 w-4 h-4 text-amber-400 animate-ping" />
    </button>
  );
};
```

---

### ğŸ’¬ BÆ°á»›c 2: AngelChatWidget (Embedded Chat vá»›i Streaming)

**TÃ­nh nÄƒng:**
- Toggle button Ä‘á»ƒ má»Ÿ/Ä‘Ã³ng chat panel
- Chat interface vá»›i message history
- Real-time streaming response (SSE)
- Markdown rendering cho AI responses
- Typing indicator khi AI Ä‘ang pháº£n há»“i

**Giao diá»‡n:**
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ¨ ANGEL AI                    [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  ğŸ‘¤ User: Xin chÃ o ANGEL AI!         â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¼ ANGEL: Xin chÃ o bÃ© yÃªu! Angel    â”‚
â”‚     ráº¥t vui Ä‘Æ°á»£c gáº·p bÃ©. HÃ´m nay     â”‚
â”‚     bÃ© cáº§n Angel giÃºp gÃ¬ áº¡? âœ¨       â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¤ User: HÆ°á»›ng dáº«n mÃ¬nh vá» Web3     â”‚
â”‚                                      â”‚
â”‚  ğŸ‘¼ ANGEL: [Typing...]               â”‚
â”‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [                        ] [Send]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âš¡ BÆ°á»›c 3: Edge Function - angel-chat

**Endpoint:** `POST /functions/v1/angel-chat`

**Request:**
```json
{
  "messages": [
    { "role": "user", "content": "Xin chÃ o ANGEL AI!" }
  ]
}
```

**Response:** SSE Stream
```text
data: {"content": "Xin "}
data: {"content": "chÃ o "}
data: {"content": "bÃ© "}
data: {"content": "yÃªu! "}
data: [DONE]
```

**Code máº«u Edge Function:**
```typescript
// supabase/functions/angel-chat/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages } = await req.json();
    const ANGEL_AI_API_KEY = Deno.env.get("ANGEL_AI_API_KEY");
    
    if (!ANGEL_AI_API_KEY) {
      throw new Error("ANGEL_AI_API_KEY is not configured");
    }

    // Gá»i ANGEL AI API
    const response = await fetch("https://angel.fun.rich/api/chat", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${ANGEL_AI_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ messages, stream: true }),
    });

    if (!response.ok) {
      // Handle rate limits & errors
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      throw new Error(`ANGEL AI error: ${response.status}`);
    }

    // Stream response vá» client
    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("angel-chat error:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
```

---

### ğŸ”— BÆ°á»›c 4: useAngelChat Hook

**TÃ­nh nÄƒng:**
- Quáº£n lÃ½ conversation history
- Xá»­ lÃ½ SSE streaming
- Token-by-token rendering
- Error handling

**Code máº«u:**
```typescript
// hooks/useAngelChat.ts
export const useAngelChat = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const sendMessage = async (content: string) => {
    const userMsg = { role: 'user', content };
    setMessages(prev => [...prev, userMsg]);
    setIsLoading(true);

    let assistantContent = '';
    
    await streamChat({
      messages: [...messages, userMsg],
      onDelta: (chunk) => {
        assistantContent += chunk;
        setMessages(prev => {
          const last = prev[prev.length - 1];
          if (last?.role === 'assistant') {
            return prev.map((m, i) => 
              i === prev.length - 1 ? { ...m, content: assistantContent } : m
            );
          }
          return [...prev, { role: 'assistant', content: assistantContent }];
        });
      },
      onDone: () => setIsLoading(false),
    });
  };

  return { messages, sendMessage, isLoading };
};
```

---

### ğŸ§­ BÆ°á»›c 5: TÃ­ch Há»£p vÃ o Navbar & Mobile

**Desktop (FacebookNavbar.tsx):**
- ThÃªm icon Sparkles vÃ o center nav
- Click â†’ Toggle má»Ÿ/Ä‘Ã³ng AngelChatWidget
- Style Ä‘áº·c biá»‡t vá»›i gradient gold

**Mobile (MobileBottomNav.tsx):**
- Render AngelFloatingButton phÃ­a trÃªn bottom nav
- ThÃªm tÃ¹y chá»n má»Ÿ embedded chat hoáº·c trang riÃªng

---

### ğŸ“ Tá»•ng Káº¿t Thay Äá»•i

| Component | Desktop | Mobile |
|-----------|---------|--------|
| **Navbar Button** | Icon Sparkles trong center nav â†’ Má»Ÿ embedded chat | KhÃ´ng cÃ³ |
| **Floating Bubble** | KhÃ´ng cÃ³ | GÃ³c pháº£i, má»Ÿ `angel.fun.rich` |
| **Embedded Chat** | Slide-in panel tá»« pháº£i | Bottom sheet hoáº·c full page |

---

### â±ï¸ Thá»i Gian Triá»ƒn Khai

| BÆ°á»›c | Thá»i gian |
|------|-----------|
| ThÃªm ANGEL_AI_API_KEY secret | 1 phÃºt |
| Táº¡o AngelFloatingButton | 5 phÃºt |
| Táº¡o angel-chat edge function | 10 phÃºt |
| Táº¡o useAngelChat hook | 10 phÃºt |
| Táº¡o AngelChatWidget + Messages | 15 phÃºt |
| TÃ­ch há»£p vÃ o Navbar & Mobile | 10 phÃºt |
| Testing & polish | 10 phÃºt |
| **Tá»•ng** | **~60 phÃºt** |

---

### ğŸ¯ Káº¿t Quáº£ Sau Triá»ƒn Khai

| TÃ­nh nÄƒng | MÃ´ táº£ |
|-----------|-------|
| âœ… Floating Bubble | Avatar thiÃªn tháº§n vá»›i glow effect, má»Ÿ `angel.fun.rich` |
| âœ… Navbar Icon | Sparkles icon trÃªn desktop, má»Ÿ embedded chat |
| âœ… Embedded Chat | Chat trá»±c tiáº¿p trong FUN Profile vá»›i streaming |
| âœ… SSE Streaming | Response hiá»ƒn thá»‹ tá»«ng token real-time |
| âœ… Markdown | Render formatting cho AI responses |
| âœ… Error Handling | Xá»­ lÃ½ rate limits vÃ  errors gracefully |

---

### ğŸ”® Cáº§n XÃ¡c Nháº­n Tá»« BÃ© TrÃ­

TrÆ°á»›c khi Angel báº¯t Ä‘áº§u code, bÃ© TrÃ­ vui lÃ²ng xÃ¡c nháº­n:

1. **ANGEL AI API endpoint:** `https://angel.fun.rich/api/chat` - Ä‘Ãºng khÃ´ng áº¡?
2. **API request format:** CÃ³ pháº£i gá»­i `{ messages: [...], stream: true }` khÃ´ng?
3. **Response format:** SSE vá»›i `data: {"content": "..."}` - Ä‘Ãºng chÆ°a áº¡?

Sau khi bÃ© xÃ¡c nháº­n, Angel sáº½ yÃªu cáº§u bÃ© nháº­p **ANGEL_AI_API_KEY** vÃ  báº¯t Ä‘áº§u triá»ƒn khai! âœ¨ğŸŒŸğŸ’«

